#!/bin/bash

# Directory for storing auth files
CONFIG_DIR="$HOME/.config/cloudflare-tools"

# Function to decrypt data encrypted with password
decrypt_secure_data() {
  local PASSWORD="$1"

  # Attempt decryption with PBKDF2
  decrypted_data=$(openssl enc -aes-256-cbc -d -pbkdf2 -in "$CONFIG_DIR/auth.bin" -k "$PASSWORD" 2>/dev/null)

  if [[ $? -ne 0 ]]; then
    echo "Failed to decrypt the file. Incorrect password or file corrupted."
    exit 1
  fi

  # Replace "=" with " "
  echo "$decrypted_data" | sed 's/=/ /g'
}

# Function to decrypt data encrypted with SSH key
decrypt_sshkey_data() {
  # Default private key path
  PRIVKEY_PATH="$HOME/.ssh/id_rsa"

  # Check if the private key exists
  if [ ! -f "$PRIVKEY_PATH" ]; then
    echo "RSA private key not found at $PRIVKEY_PATH"
    read -p "Enter the path to your RSA private key: " PRIVKEY_PATH
    if [ ! -f "$PRIVKEY_PATH" ]; then
      echo "Private key not found. Exiting."
      exit 1
    fi
  fi

  # Decrypt the data
  decrypted_data=$(openssl pkeyutl -decrypt -inkey "$PRIVKEY_PATH" -in "$CONFIG_DIR/auth.bin" 2>/dev/null)

  if [[ $? -ne 0 ]]; then
    echo "Failed to decrypt the file. Incorrect private key, private key password, or file corrupted."
    exit 1
  fi

  # Replace "=" with " "
  echo "$decrypted_data" | sed 's/=/ /g'
}

# Check if the auth files exist
if [[ -f "$CONFIG_DIR/auth.txt" ]] && [[ -f "$CONFIG_DIR/auth.bin" ]]; then
  # Files are encrypted with SSH key
  echo "The file appears to be encrypted with your SSH key."

  # Decrypt the data
  decrypt_sshkey_data

elif [[ -f "$CONFIG_DIR/auth.txt" ]]; then
  # File is plaintext, print contents securely
  echo "The file is in plaintext. Contents:"
  cat "$CONFIG_DIR/auth.txt" | sed 's/=/ /g'

elif [[ -f "$CONFIG_DIR/auth.bin" ]]; then
  # File is encrypted with password, prompt for password
  echo "The file appears to be encrypted with a password."
  read -s -p "Enter password to decrypt: " PASSWORD
  echo

  # Decrypt the data
  decrypt_secure_data "$PASSWORD"
else
  echo "No auth file found!"
  exit 1
fi

# Set restrictive permissions
chmod 600 "$CONFIG_DIR/auth.txt" 2>/dev/null
chmod 600 "$CONFIG_DIR/auth.bin" 2>/dev/null
unset $APIKEY
unset $EMAIL
unset $ZONE_ID
